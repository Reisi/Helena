/**
  ******************************************************************************
  * @file    pitch_reg.c
  * @author  Thomas Reisnecker
  * @brief   tbd.
  ******************************************************************************
  */

/* Includes ------------------------------------------------------------------*/
#include <stddef.h>

#include "pitch_reg.h"

/* External variables --------------------------------------------------------*/

/* Private defines -----------------------------------------------------------*/
#define LUTSIZE 256

#define OPTICMASK_15    (1 << PRG_TYPE_15)
#define OPTICMASK_22    (1 << PRG_TYPE_22)
#define OPTICMASK_30    (1 << PRG_TYPE_30)
#define OPTICMASK_ALL   (OPTICMASK_15 | OPTICMASK_22 | OPTICMASK_30)
#define OPTICMASK_CROSS (OPTICMASK_15 | OPTICMASK_30)

/* Private typedef -----------------------------------------------------------*/
typedef int32_t q15_16_t;

typedef struct
{
    q15_t    pitch[LUTSIZE];
    q15_16_t comp[LUTSIZE];
} lut_t;

typedef struct
{
    q15_t fullAngle;
    q15_t zeroAngle;
} cross_t;

/* Private macros ------------------------------------------------------------*/

/* Private read only variables -----------------------------------------------*/
static lut_t const lut[] =
{
    {   // LUT for 15° optic
        .pitch =
        {
            -8192, -8006, -7821, -7637, -7454, -7272, -7093, -6916, -6742,
            -6572, -6404, -6241, -6081, -5925, -5773, -5625, -5481, -5341,
            -5206, -5075, -4948, -4825, -4706, -4591, -4480, -4372, -4268,
            -4168, -4071, -3977, -3886, -3799, -3714, -3632, -3553, -3477,
            -3403, -3331, -3262, -3195, -3130, -3067, -3007, -2948, -2890,
            -2835, -2781, -2729, -2678, -2629, -2581, -2535, -2490, -2446,
            -2403, -2362, -2322, -2282, -2244, -2207, -2170, -2135, -2100,
            -2067, -2034, -2002, -1970, -1940, -1910, -1881, -1852, -1824,
            -1797, -1770, -1744, -1718, -1693, -1669, -1645, -1621, -1598,
            -1576, -1553, -1532, -1510, -1490, -1469, -1449, -1429, -1410,
            -1391, -1372, -1353, -1335, -1318, -1300, -1283, -1266, -1249,
            -1233, -1217, -1201, -1185, -1170, -1155, -1140, -1125, -1111,
            -1097, -1083, -1069, -1055, -1042, -1028, -1015, -1002, -990, -977,
             -965, -952, -940, -928, -916, -905, -893, -882, -871, -860, -849,
             -838, -827, -817, -806, -796, -786, -776, -766, -756, -746, -736,
             -727, -717, -708, -698, -689, -680, -671, -662, -653, -645, -636,
             -627, -619, -610, -602, -594, -586, -577, -569, -561, -554, -546,
             -538, -530, -523, -515, -507, -500, -493, -485, -478, -471, -464,
             -456, -449, -442, -435, -428, -422, -415, -408, -401, -395, -388,
             -382, -375, -369, -362, -356, -349, -343, -337, -331, -324, -318,
             -312, -306, -300, -294, -288, -282, -276, -270, -265, -259, -253,
             -247, -242, -236, -230, -225, -219, -214, -208, -203, -197, -192,
             -187, -181, -176, -171, -165, -160, -155, -150, -145, -139, -134,
             -129, -124, -119, -114, -109, -104, -99, -94, -89, -85, -80, -75,
             -70, -65, -60, -56, -51, -46, -42, -37, -32, -28, -23, -18, -14,
             -9, -5, 0
        },
        .comp =
        {
            2128, 2131, 2139, 2152, 2171, 2195, 2224, 2258, 2298, 2343, 2394,
            2449, 2511, 2577, 2649, 2726, 2809, 2897, 2990, 3088, 3193, 3302,
            3417, 3537, 3663, 3794, 3931, 4073, 4220, 4373, 4532, 4696, 4866,
            5041, 5222, 5408, 5600, 5798, 6001, 6210, 6425, 6645, 6871, 7103,
            7340, 7584, 7833, 8088, 8348, 8615, 8888, 9166, 9451, 9741, 10037,
            10340, 10648, 10963, 11284, 11611, 11944, 12283, 12629, 12980,
            13339, 13703, 14074, 14451, 14835, 15225, 15622, 16025, 16435,
            16851, 17274, 17704, 18140, 18584, 19034, 19491, 19955, 20426,
            20904, 21389, 21881, 22380, 22887, 23400, 23921, 24449, 24985,
            25528, 26079, 26637, 27202, 27776, 28357, 28945, 29542, 30146,
            30759, 31379, 32007, 32644, 33288, 33941, 34602, 35272, 35950,
            36636, 37331, 38034, 38747, 39467, 40197, 40936, 41683, 42440,
            43205, 43980, 44764, 45558, 46361, 47173, 47995, 48826, 49667,
            50518, 51379, 52250, 53131, 54022, 54923, 55834, 56756, 57688,
            58631, 59585, 60549, 61525, 62511, 63508, 64516, 65536, 66567,
            67609, 68663, 69729, 70806, 71896, 72997, 74110, 75236, 76373,
            77524, 78686, 79862, 81050, 82251, 83465, 84692, 85932, 87186,
            88453, 89734, 91029, 92338, 93660, 94997, 96348, 97713, 99093,
            100488, 101897, 103322, 104762, 106216, 107687, 109173, 110674,
            112192, 113725, 115275, 116841, 118424, 120023, 121639, 123272,
            124922, 126590, 128275, 129978, 131698, 133437, 135194, 136969,
            138763, 140576, 142407, 144258, 146128, 148018, 149927, 151856,
            153806, 155776, 157766, 159777, 161809, 163863, 165937, 168034,
            170152, 172292, 174455, 176640, 178848, 181079, 183333, 185610,
            187912, 190237, 192586, 194960, 197359, 199783, 202232, 204706,
            207206, 209732, 212285, 214864, 217470, 220103, 222764, 225452,
            228168, 230913, 233686, 236489, 239320, 242181, 245072, 247993,
            250945, 253927, 256941, 259986, 263063, 266172, 269313, 272488,
            275695, 278936, 282211, 285521
        }
    },
    {   // LUT for 22° optic
        .pitch =
        {
            -8192, -8067, -7942, -7817, -7693, -7569, -7446, -7324, -7203,
            -7082, -6963, -6844, -6728, -6612, -6498, -6385, -6274, -6165,
            -6057, -5951, -5847, -5745, -5644, -5545, -5448, -5353, -5260,
            -5169, -5079, -4991, -4905, -4821, -4739, -4658, -4579, -4502,
            -4427, -4353, -4280, -4210, -4140, -4073, -4007, -3942, -3878,
            -3817, -3756, -3697, -3639, -3582, -3526, -3472, -3419, -3367,
            -3316, -3266, -3217, -3169, -3123, -3077, -3032, -2988, -2944,
            -2902, -2861, -2820, -2780, -2741, -2703, -2665, -2628, -2592,
            -2556, -2522, -2487, -2454, -2421, -2388, -2356, -2325, -2294,
            -2264, -2234, -2205, -2176, -2148, -2120, -2093, -2066, -2039,
            -2013, -1987, -1962, -1937, -1913, -1889, -1865, -1841, -1818,
            -1796, -1773, -1751, -1729, -1708, -1687, -1666, -1645, -1625,
            -1605, -1585, -1565, -1546, -1527, -1508, -1490, -1471, -1453,
            -1435, -1418, -1400, -1383, -1366, -1349, -1332, -1316, -1300,
            -1283, -1268, -1252, -1236, -1221, -1206, -1191, -1176, -1161,
            -1146, -1132, -1118, -1103, -1089, -1075, -1062, -1048, -1035,
            -1021, -1008, -995, -982, -969, -956, -944, -931, -919, -907, -894,
            -882, -870, -858, -847, -835, -823, -812, -801, -789, -778, -767,
            -756, -745, -734, -723, -713, -702, -691, -681, -671, -660, -650,
            -640, -630, -620, -610, -600, -590, -580, -571, -561, -552, -542,
            -533, -523, -514, -505, -496, -486, -477, -468, -459, -450, -442,
            -433, -424, -415, -407, -398, -390, -381, -373, -364, -356, -348,
            -339, -331, -323, -315, -307, -299, -291, -283, -275, -267, -259,
            -251, -243, -236, -228, -220, -213, -205, -197, -190, -182, -175,
            -168, -160, -153, -145, -138, -131, -124, -117, -109, -102, -95,
            -88, -81, -74, -67, -60, -53, -46, -39, -33, -26, -19, -12, -5
        },
        .comp =
        {
            4171, 4174, 4181, 4192, 4208, 4229, 4254, 4284, 4319, 4358, 4402,
            4450, 4503, 4561, 4623, 4690, 4762, 4838, 4919, 5005, 5095, 5190,
            5290, 5394, 5504, 5617, 5736, 5859, 5987, 6120, 6258, 6400, 6548,
            6700, 6857, 7018, 7185, 7356, 7533, 7714, 7900, 8092, 8288, 8489,
            8695, 8906, 9122, 9343, 9570, 9801, 10037, 10279, 10526, 10778,
            11035, 11297, 11565, 11838, 12116, 12400, 12689, 12983, 13283,
            13588, 13898, 14214, 14536, 14863, 15196, 15534, 15878, 16228,
            16583, 16944, 17311, 17684, 18062, 18447, 18837, 19233, 19635,
            20044, 20458, 20878, 21305, 21737, 22176, 22621, 23073, 23531,
            23995, 24465, 24942, 25426, 25916, 26413, 26916, 27426, 27943,
            28466, 28997, 29534, 30078, 30630, 31188, 31753, 32326, 32906,
            33493, 34087, 34688, 35298, 35914, 36538, 37170, 37809, 38456,
            39111, 39774, 40444, 41123, 41810, 42504, 43207, 43918, 44638,
            45365, 46102, 46846, 47600, 48361, 49132, 49912, 50700, 51497,
            52303, 53119, 53943, 54777, 55620, 56473, 57335, 58207, 59088,
            59979, 60880, 61791, 62712, 63643, 64584, 65536, 66498, 67470,
            68453, 69447, 70451, 71467, 72493, 73530, 74579, 75638, 76710,
            77792, 78886, 79992, 81110, 82240, 83381, 84535, 85701, 86880,
            88070, 89274, 90490, 91719, 92962, 94217, 95485, 96767, 98062,
            99371, 100694, 102030, 103381, 104745, 106124, 107518, 108925,
            110348, 111786, 113238, 114706, 116189, 117687, 119201, 120731,
            122276, 123838, 125416, 127010, 128621, 130249, 131893, 133555,
            135234, 136930, 138644, 140375, 142125, 143893, 145678, 147483,
            149306, 151148, 153009, 154889, 156789, 158708, 160648, 162607,
            164587, 166587, 168607, 170649, 172712, 174796, 176901, 179029,
            181178, 183350, 185544, 187761, 190001, 192264, 194550, 196860,
            199194, 201552, 203935, 206342, 208774, 211231, 213714, 216222,
            218757, 221318, 223905, 226519, 229161, 231829, 234526, 237250,
            240003, 242784, 245595, 248434
        }
    },
    {   // LUT for 30° optic
        .pitch =
        {
            -8192, -8096, -8001, -7906, -7811, -7716, -7621, -7527, -7433,
            -7339, -7246, -7153, -7061, -6970, -6879, -6789, -6700, -6611,
            -6524, -6437, -6351, -6266, -6181, -6098, -6016, -5934, -5854,
            -5774, -5696, -5618, -5542, -5466, -5392, -5319, -5246, -5175,
            -5105, -5035, -4967, -4900, -4834, -4769, -4704, -4641, -4579,
            -4518, -4457, -4398, -4340, -4282, -4225, -4170, -4115, -4061,
            -4008, -3955, -3904, -3853, -3804, -3754, -3706, -3659, -3612,
            -3566, -3520, -3476, -3432, -3389, -3346, -3304, -3263, -3222,
            -3182, -3142, -3103, -3065, -3027, -2990, -2953, -2917, -2882,
            -2847, -2812, -2778, -2744, -2711, -2678, -2646, -2614, -2583,
            -2552, -2521, -2491, -2461, -2432, -2403, -2375, -2346, -2318,
            -2291, -2264, -2237, -2210, -2184, -2158, -2133, -2108, -2083,
            -2058, -2034, -2010, -1986, -1962, -1939, -1916, -1893, -1871,
            -1849, -1827, -1805, -1783, -1762, -1741, -1720, -1700, -1679,
            -1659, -1639, -1619, -1600, -1580, -1561, -1542, -1523, -1505,
            -1486, -1468, -1450, -1432, -1414, -1396, -1379, -1361, -1344,
            -1327, -1310, -1294, -1277, -1261, -1244, -1228, -1212, -1196,
            -1180, -1165, -1149, -1134, -1119, -1104, -1089, -1074, -1059,
            -1044, -1030, -1015, -1001, -987, -972, -958, -944, -931, -917,
            -903, -890, -876, -863, -850, -836, -823, -810, -797, -785, -772,
            -759, -747, -734, -722, -709, -697, -685, -673, -661, -649, -637,
            -625, -613, -601, -590, -578, -567, -555, -544, -533, -521, -510,
            -499, -488, -477, -466, -455, -444, -434, -423, -412, -402, -391,
            -380, -370, -360, -349, -339, -329, -318, -308, -298, -288, -278,
            -268, -258, -248, -239, -229, -219, -209, -200, -190, -180, -171,
            -161, -152, -142, -133, -124, -114, -105, -96, -87, -77, -68, -59,
            -50, -41, -32, -23, -14, -5
        },
        .comp =
        {
            7046, 7048, 7055, 7066, 7081, 7101, 7125, 7154, 7187, 7224, 7266,
            7312, 7363, 7418, 7477, 7541, 7610, 7683, 7760, 7842, 7928, 8019,
            8114, 8214, 8318, 8426, 8540, 8657, 8780, 8907, 9038, 9174, 9315,
            9460, 9610, 9764, 9923, 10087, 10255, 10428, 10606, 10788, 10976,
            11168, 11364, 11566, 11772, 11983, 12199, 12420, 12646, 12877,
            13112, 13353, 13598, 13848, 14104, 14364, 14630, 14900, 15176,
            15457, 15743, 16034, 16331, 16632, 16939, 17251, 17569, 17891,
            18220, 18553, 18892, 19237, 19587, 19942, 20303, 20670, 21042,
            21420, 21804, 22193, 22589, 22990, 23396, 23809, 24228, 24652,
            25083, 25519, 25962, 26411, 26866, 27327, 27794, 28268, 28748,
            29234, 29727, 30226, 30732, 31244, 31763, 32288, 32820, 33359,
            33905, 34458, 35017, 35584, 36157, 36738, 37325, 37920, 38522,
            39131, 39748, 40372, 41003, 41642, 42289, 42943, 43605, 44274,
            44952, 45637, 46330, 47032, 47741, 48459, 49184, 49918, 50661,
            51411, 52171, 52939, 53715, 54500, 55294, 56097, 56909, 57730,
            58560, 59399, 60247, 61105, 61972, 62848, 63735, 64630, 65536,
            66451, 67377, 68312, 69258, 70214, 71180, 72156, 73143, 74141,
            75149, 76168, 77198, 78239, 79291, 80354, 81428, 82514, 83611,
            84720, 85841, 86974, 88118, 89275, 90443, 91624, 92818, 94023,
            95242, 96473, 97717, 98975, 100245, 101529, 102826, 104136, 105460,
            106798, 108150, 109516, 110896, 112290, 113699, 115123, 116561,
            118014, 119483, 120966, 122465, 123979, 125509, 127055, 128616,
            130194, 131788, 133399, 135026, 136670, 138331, 140009, 141705,
            143418, 145148, 146896, 148663, 150447, 152250, 154072, 155912,
            157771, 159649, 161547, 163464, 165401, 167358, 169335, 171333,
            173351, 175389, 177449, 179530, 181632, 183756, 185902, 188070,
            190260, 192473, 194709, 196968, 199250, 201555, 203884, 206238,
            208615, 211017, 213444, 215896, 218374, 220876, 223405, 225960,
            228541, 231149, 233784, 236446, 239136
        }
    },
};

static cross_t const crossing[] =
{
    {   // multioptic config for 15°
        .fullAngle = 0,     // 0°
        .zeroAngle = -2048, // -22.5°
    },
    {   // multioptic config for 22°
        .fullAngle = 0,
        .zeroAngle = 0,
    },
    {   // multioptic config for 30°
        .fullAngle = -2048, // -22.5°
        .zeroAngle = 1024   // 11.25°
    }
};

/* Private variables ---------------------------------------------------------*/

/* Private functions ---------------------------------------------------------*/
q15_16_t getCompFromLut(q15_t pitch, prg_opticType_t optic)
{
    uint_fast8_t index, neighborIndex, jumpsize;
    lut_t const* pLut = &lut[optic];
    int32_t i;

    index    = LUTSIZE >> 1;
    jumpsize = index >> 1;
    while (jumpsize)
    {
        index += pitch > pLut->pitch[index] ? jumpsize : -jumpsize;
        jumpsize >>= 1;
    }

    // if desired angle is outside LUT, just return the first or last value
    if (index == LUTSIZE - 1 || index == 0)
    {
        return pLut->comp[index];
    }

    // otherwise use a linear approximation
    neighborIndex = pitch > pLut->pitch[index] ? index + 1 : index - 1;

    i = pitch - pLut->pitch[index];
    i *= pLut->comp[neighborIndex] - pLut->comp[index];
    i /= pLut->pitch[neighborIndex] - pLut->pitch[index];
    i += pLut->comp[index];

    return i;
}

/** @brief helper function that converts the -360..360 input angle range to
 *         -90..90° range (angles in the 2nd and 3rd quadrant will be flipped
 *         to 1st and 4th)
 */
static q15_t convertAngle(q15_t angle)
{
    // convert 180..360 range to -180..0 range
    if (angle > (1 << 14))
        angle -= (1l << 15);
    // convert -360..-180 range to 0..180 range
    else if (-angle > (1 << 14))
        angle += (1l << 15);

    // flip 90..180 to 90..0
    if (angle > (1 << 13))
        angle = (1 << 14) - angle;
    // flip -90..-180 to -90..0
    else if (-angle > (1 << 13))
        angle = -1 * (1 << 14) - angle;

    return angle;
}

static q15_16_t getCrossFactor(cross_t const* pCross, q15_t angle)
{
    int32_t i;

    // crossing not supported for 22°, always 1
    if (pCross->fullAngle == pCross->zeroAngle)
        return UINT16_MAX;

    i = angle - pCross->zeroAngle;
    i <<= 16;
    i /= pCross->fullAngle - pCross->zeroAngle;

    if (i < 0)
        return 0;
    if (i > UINT16_MAX)
        return UINT16_MAX;
    else
        return i;
}

/* Public functions ----------------------------------------------------------*/
ret_code_t prg_GetComp(q15_t pitch, prg_optic_t const* pOptic, int32_t* pInt)
{
    if (pInt == NULL || pOptic == NULL)
        return NRF_ERROR_NULL;

    if (pOptic->type >= PRG_TYPE_CNT)
        return NRF_ERROR_INVALID_PARAM;

    q15_t angle = convertAngle(pitch + pOptic->offset);
    q15_16_t comp = getCompFromLut(angle, pOptic->type);
    int64_t newInt = *pInt;
    newInt *= comp;
    newInt >>= 16;
    *pInt = newInt;

    return NRF_SUCCESS;
}

ret_code_t prg_MultiOptic(q15_t pitch, prg_optic_t const* pOptic, int32_t* pInt)
{
    if (pOptic == NULL || pInt == NULL)
        return NRF_ERROR_NULL;

    if (pOptic->type >= PRG_TYPE_CNT)
        return NRF_ERROR_INVALID_PARAM;

    if (pOptic->type == PRG_TYPE_22)
        return NRF_ERROR_NOT_SUPPORTED;

    q15_t angle = convertAngle(pitch + pOptic->offset);
    int64_t newInt = *pInt;
    newInt *= getCrossFactor(&crossing[pOptic->type], angle);
    newInt >>= 16;
    *pInt = newInt;

    return NRF_SUCCESS;
}

/**END OF FILE*****************************************************************/
